## 9.9 SNMP exercises

For this experiment, we will use the topology illustrated here, with IP addresses as noted on the diagram and a subnet mask of 255.255.255.0 on each interface:


![Network topology](security-topology.svg)

To set up this topology in the GENI Portal, create a slice, click on "Add Resources", and load the RSpec from the following URL: [https://raw.githubusercontent.com/ffund/tcp-ip-essentials/master/lab9/lab9-security-rspec.xml](https://raw.githubusercontent.com/ffund/tcp-ip-essentials/master/lab9/lab9-security-rspec.xml)

Refer to the [monitor website](https://fedmon.fed4fire.eu/overview/instageni) to identify an InstaGENI site that has many "free VMs" available.  Then bind to an InstaGENI site and reserve your resources. Wait for them to become available for login ("turn green" on your canvas) and then SSH into each, using the details given in the GENI Portal.


### SNMP setup

In this exercise, we will see how SNMP can be used to monitor networked devices.

On the "internal" router, "router-int", run

```
sudo sysctl net.ipv4.ip_forward=1
```

to enable packet forwarding.

Next, we will set up SNMP. 

First, download MIBs on the following nodes: "romeo", "router-int", and "public". Run

```
sudo apt-get update
sudo apt-get -y install snmp-mibs-downloader
```

Then run

```
sudo download-mibs
```

on those three nodes.

On the "router-int" node, install the SNMP daemon (server) with:

```
sudo apt-get update
sudo apt-get -y install snmpd
```

On the "romeo" and "public" nodes, install the SNMP client with:

```
sudo apt-get update
sudo apt-get -y install snmp
```



### Exercise 1: Configuring SNMP

On the "router" node, use

```
service snmpd status
```

to verify that the SNMP daemon is running. Try to stop it with

```
sudo service snmpd stop
```

and start it again with

```
sudo service snmpd start
```

The SNMP configuration file is located at `/etc/snmp/snmpd.conf`.  

Open the configuration file and study the configuration options with

```
sudo nano /etc/snmp/snmpd.conf
```

Note that lines not "commented out", i.e. not preceded by a `#` character, are active.

Make the following changes to the configuration:

1 - Listen for connections on all interfaces. Comment out the line 

```
agentAddress  udp:127.0.0.1:161
```

and un-comment the line

```
#agentAddress udp:161,udp6:[::1]:161
```

2 - Allow read-only access using the "secret" community string for hosts in 10.10.2.0/24. Un-comment the line

```
#rocommunity secret  10.0.0.0/16
```

and change it to read

```
rocommunity secret  10.10.3.0/24
```

Hit Ctrl+O and Enter to save the file, and Ctrl+X to exit `nano`.

Finally, restart the service with


```
sudo service snmpd restart
```

Use

```
service snmpd status
```

to verify that the SNMP daemon is running. If you made a mistake in editing the configuration file, then the service may fail at this point, so you'll need to go back and correct your mistake.

Also, examine the MIBs, which are located in the `/usr/share/snmp/mibs` directory and its subdirectories. In particular, study the interface MIB with

```
less /usr/share/snmp/mibs/ietf/IF-MIB
```

and the TCP MIB with

```
less /usr/share/snmp/mibs/ietf/TCP-MIB
```

**Lab report**: By default (before your changes to the configuration file), will the SNMP service allow connections from remote hosts? Explain what the effect of your change to the `agentAddress` option will be.

**Lab report**: Explain how the lines

```
view   systemonly  included   .1.3.6.1.2.1.1
view   systemonly  included   .1.3.6.1.2.1.25.1
rocommunity public  default    -V systemonly
```

work together. What MIBs can be read using the "public" community string? What MIBs can be edited using the "public" community string?

**Lab report**: What is the effect of adding the line

```
rocommunity secret  10.10.1.0/24
```

to the configuration file?

**Lab report**: What is the data type and the description of the MIB objects `IF-MIB::ifDescr`, `IF-MIB::ifInUcastPkts`, `IF-MIB::ifPhysAddress`, and `IF-MIB::ifOutUcastPkts`?


### Exercise 2: Retrieving SNMP data

We will use the `snmpwalk` utility to probe the SNMP daemon running on the router.

Open two SSH sessions to the "router" node. In one, run

```
sudo tcpdump -i eth1 -w snmpwalk-public-eth1-$(hostname -s).pcap
```

and in the other, run

```
sudo tcpdump -i eth2 -w snmpwalk-public-eth2-$(hostname -s).pcap
```

Leave these running.

On the "romeo" host, run

```
snmpwalk -v 2c -c public router-int
```

and on the "public" host, run the same command, 

```
snmpwalk -v 2c -c public router-int
```

Save the output for your lab report. Then, stop both `tcpdump` instances on "router-int".

Next, we will try to probe using the "secret" community string. On "router-int", run

```
sudo tcpdump -i eth1 -w snmpwalk-secret-eth1-$(hostname -s).pcap
```

in one session, and

```
sudo tcpdump -i eth2 -w snmpwalk-secret-eth2-$(hostname -s).pcap
```

in the other. Leave these running.

On the "romeo" host, run

```
snmpwalk -v 2c -c secret router-int
```

and on the "public" host, run the same command, 

```
snmpwalk -v 2c -c secret router-int 
```

Save the output (or at least, a subset of it) for your lab report. Then, stop both `tcpdump` instances on "router-int".

Transfer the packet captures to your laptop with `scp`.

**Lab report**: What is the difference in the output when running `snmpwalk` on the "romeo" host with "public" as the community string, versus "secret" as the community string? Explain why this occurs, using evidence from the SNMP configuration file.

**Lab report**: What is the difference in the output when running  `snmpwalk` with "secret" as the community string on the "romeo" host, versus on the "juliet" host? Explain why this occurs, using evidence from the SNMP configuration file.

### Exercise 3: Retrieving SNMP data, continued


We can also use `snmpget` to get an individual MIB object, rather than probing a sequence of MIB objects.

On the router, run

```
sudo tcpdump -i eth1 -w snmpget-eth1-$(hostname -s).pcap
```

in one session, and

```
sudo tcpdump -i eth2 -w snmpget-eth2-$(hostname -s).pcap
```

in the other. Leave these running. Then, on "public", run

```
snmpget -v 2c -c secret router-int IF-MIB::ifDescr.4
snmpget -v 2c -c secret router-int IF-MIB::ifInUcastPkts.4
snmpget -v 2c -c secret router-int IF-MIB::ifPhysAddress.4
snmpget -v 2c -c secret router-int IF-MIB::ifOutUcastPkts.4
```

Save the output for your lab report.

Also run


```
snmpwalk -v 2c -c secret router-int IF-MIB::ifTable
```

and save the output.

Stop the `tcpdump` instances on the router, and then run

```
ifconfig
```

on the router. Save the output.

Transfer the packet captures to your laptop with `scp`.

**Lab report**: Show the relevant section of the `ifconfig` output on the router, and how it corresponds to the interface information you collected using SNMP.

**Lab report**: Draw the format of one of the (successful) SNMP response messages saved, including the name and value of each field.

Once you are done with this part of the lab , proceed to the [next part](el5373-lab9-910.md)


### Optional exercise: Use SNMP to collect data for a network traffic visualization

In this *optional* exercise, we'll use SNMP to get data to visualize network traffic on the router.

RRDtool is a popular tool to store and process data collected via SNMP using an efficient database format called a *round robin database* (RRD). Install it on the "public" node with


```
sudo apt-get -y install rrdtool
```

Next, on the "public" node, use `rrdtool` to create a new "database" in which to store data, and with :

```
rrdtool create traffic.rrd \
	--step 5 \
	DS:rtreth0rx:COUNTER:120:0:U \
	DS:rtreth0tx:COUNTER:120:0:U \
	DS:rtreth1rx:COUNTER:120:0:U \
	DS:rtreth1tx:COUNTER:120:0:U \
	DS:rtreth2rx:COUNTER:120:0:U \
	DS:rtreth2tx:COUNTER:120:0:U \
	DS:rtreth3rx:COUNTER:120:0:U \
	DS:rtreth3tx:COUNTER:120:0:U \
	RRA:AVERAGE:0.5:1:3600 \
	RRA:MAX:0.5:1:3600
```

Run `ls` and note that the file `traffic.rrd` has been created.

Now, we're going to use SNMP to collect data for this database. We'll collect data for least an hour, while we continue working on the rest of the lab. To let this script run in the background, even if the SSH session disconnected, we'll use `screen`. Run


```
screen -S monitor
```

to create a new screen session named "monitor". Inside this `screen` session, run



```
while true; do
  rrdupdate traffic.rrd N:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifInOctets.2`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifOutOctets.2`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifInOctets.3`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifOutOctets.3`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifInOctets.4`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifOutOctets.4`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifInOctets.5`:\
	`snmpget -v 2c -c secret -Oqv router-int IF-MIB::ifOutOctets.5`
  echo "Last update at $(date)"
  sleep 5
done
```

to update the database with new traffic information (from SNMP) every 5 seconds.

To detach from the `screen` session, use Ctrl+A and then type D. You'll see a message "Detached from XXX.monitor". 


After about an hour, you should have enough data to visualize! Run

```
rrdtool graph traffic-in.png --start -1800  \
	-a PNG -t "Network Activity" --vertical-label "bytes/s" \
	-w 600 -h 400 -r \
	DEF:rtreth0rx=traffic.rrd:rtreth0rx:AVERAGE \
	DEF:rtreth1rx=traffic.rrd:rtreth1rx:AVERAGE \
	DEF:rtreth2rx=traffic.rrd:rtreth2rx:AVERAGE \
	DEF:rtreth3rx=traffic.rrd:rtreth3rx:AVERAGE \
	LINE2:rtreth0rx#D73600:RTR_ETH0-RX \
	LINE2:rtreth1rx#0101D6:RTR_ETH1-RX \
	LINE2:rtreth2rx#00D730:RTR_ETH2-RX \
	LINE2:rtreth3rx#D7CC00:RTR_ETH3-RX
```
and

```
rrdtool graph traffic-out.png --start -1800  \
	-a PNG -t "Network Activity" --vertical-label "bytes/s" \
	-w 600 -h 400 -r \
	DEF:rtreth0tx=traffic.rrd:rtreth0tx:AVERAGE \
	DEF:rtreth1tx=traffic.rrd:rtreth1tx:AVERAGE \
	DEF:rtreth2tx=traffic.rrd:rtreth2tx:AVERAGE \
	DEF:rtreth3tx=traffic.rrd:rtreth3tx:AVERAGE \
	LINE2:rtreth0tx#D73600:RTR_ETH0-TX \
	LINE2:rtreth1tx#0101D6:RTR_ETH1-TX \
	LINE2:rtreth2tx#00D730:RTR_ETH2-TX \
	LINE2:rtreth3tx#D7CC00:RTR_ETH3-TX
```

to generate two plots, "traffic-in.png" and "traffic-out.png". Use `scp` to transfer these to your laptop.

In this exercise, we used SNMP to monitor network activity on *one* router - we could just as easily have gathered this data on the router itself, without SNMP! However, when we have many routers and networked devices to monitor, SNMP helps us track them all from one convenient centralized location.
