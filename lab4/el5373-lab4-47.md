## 4.7 Routing experiments with ICMP

For this experiment, we will reuse the same network as in the previous experiment. 

While the routers can learn new routes using RIP, the workstations will not. You will have to add a route on each workstation so that it can reach other workstations outside its own subnet, by going through a local router.

On romeo, set up router 1 as the gateway for the entire 10.10.0.0/16 subnet:

```
sudo route add -net 10.10.0.0 netmask 255.255.0.0 gw 10.10.61.1
```

On hamlet, set up router 2 as the gateway for the entire 10.10.0.0/16 subnet:

```
sudo route add -net 10.10.0.0 netmask 255.255.0.0 gw 10.10.62.2
```

On othello, set up router 3 as the gateway for the entire 10.10.0.0/16 subnet:

```
sudo route add -net 10.10.0.0 netmask 255.255.0.0 gw 10.10.63.3
```

On petruchio, set up router 4 as the gateway for the entire 10.10.0.0/16 subnet:

```
sudo route add -net 10.10.0.0 netmask 255.255.0.0 gw 10.10.64.4
```

With this configuration, every host should be able to reach every other host. However, it will not necessarily use the shortest path. For example, the shortest path from romeo to petruchio would be romeo ðŸ¡’ router 4 ðŸ¡’ petruchio. But, because romeo uses router 1 as its gateway to the other subnets, it will send traffic to petruchio using a longer path: romeo ðŸ¡’ router 1 ðŸ¡’ router 2 ðŸ¡’ router 3 ðŸ¡’ petruchio.

In this section, we will see how routers can use an ICMP redirect message to inform hosts of a better route, like the one described above.


On one workstation in each network segment, run

```
sudo tcpdump -i eth1 -w $(hostname -s)-redirect-1.pcap
```

Then, `ping` from "romeo" to "petruchio". On "romeo", run

```
ping 10.10.64.100
```

After capturing an ICMP redirect message, save the `ping` output and stop the ping.

On "romeo", run

```
traceroute 10.10.64.100
```

and save the output. Also, stop the `tcpdump` processes.

By default, our workstations will not apply the routes suggested by the ICMP redirect message. To enable those routes, run

```
sudo sysctl -w net.ipv4.conf.all.accept_redirects=1
```

on "romeo". Restart the `tcpdump` processes on each segment, but write to a new file, with

```
sudo tcpdump -i eth1 -w $(hostname -s)-redirect-2.pcap
```

Then, run 

```
ping 10.10.64.100
```

again on romeo until you see an ICMP redirect. Stop the ping and run

```
traceroute 10.10.64.100
```

and save the output. Then, stop the `tcpdump` processes.

**Lab report**: Identify every field in the ICMP redirect message that you captured (see Fig. 4.2).

**Lab report**: Show the `traceroute` output before and after the ICMP redirect instruction was applied, and explain the change.

**Lab report**: From the tcpdump output, explain how the multi-hop route was found using `traceroute`. Explain the sequence of the ICMP messages used.
